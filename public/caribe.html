<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href="caribe.css"> </link>
<link rel="stylesheet" type="text/css" href="lib/bootstrap.min.css"> </link>
<link rel="stylesheet" type="text/css" href="lib/bootstrap-theme.min.css"> </link>
<link href="favicon.ico" rel="shortcut icon" type="image/x-icon" />
<head>
  <title>Petrocaribe</title
</head>
<body>
  <header class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="#">
          <span class="glyphicon glyphicon-oil" aria-hidden="true"></span>
          Petrocaribe: A Comedy of Errors
        </a>
      </div>
    </div>
  </header>
  <div class="row">
    <div class="col-sm-4">
      <div class="panel panel-info" id="content-panel">
        <div class="panel-heading">
          <h3 class="panel-title">
            <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
            <span class="content-title">Introduction</span>
          </h3>
        </div>
        <div class="panel-body">
          <ol class="breadcrumb">
            <li><a href="#">Home</a></li>
            <li><a href="#">Library</a></li>
            <li class="active">Data</li>
            <li><a href="#">Lol</a></li>
          </ol>
          <div class="panel-content">
            <b>Petrocaribe</b> is an oil alliance of many Caribbean states with Venezuela to purchase oil on conditions of preferential payment. The alliance was launched on 29 June 2005 in Puerto La Cruz, Venezuela. In 2013 Petrocaribe agreed links with the Bolivarian Alliance for the Americas (ALBA), to go beyond oil and promote economic cooperation.
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-8">
      <div class="panel panel-info">
        <div class="panel-heading">
          <h3 class="panel-title">
            <span class="glyphicon glyphicon-map-marker" aria-hidden="true"></span>
            Petrocaribe Countries <small>(click each country for more details)</small>
          </h3>
        </div>
        <div id="map">
        </div>
        <div class="panel-footer">Sources: Petrocaribe, SELA, and IndexMundi</div>
      </div>
    </div>
  </div>
  <script src="lib/d3.v3.min.js" charset="utf-8"></script>
  <script src="lib/topojson.v1.min.js"></script>
  <script src="lib/jquery.min.js"></script>
  <script src="lib/bootstrap.min.js" charset="utf-8"></script>
  <script type="text/javascript">
    var margin = {top: 0, left: 0, bottom: 0, right: 0}
      , width = parseInt(d3.select('#map').style('width'))
      , width = width - margin.left - margin.right
      , mapRatio = .65
      , height = width * mapRatio;

    var svg = d3.select("#map").append("svg")
    		.attr("width", width)
        .attr("height", height)
				.attr("class", "root");

    var hiddenCountries = ['COL', 'BRA', 'PRI', 'FRA', 'MEX', 'BRB',
		                       'USA', 'ECU', 'PER', 'PAN', 'CRI', 'TTO', 'LCA', 'BHS'];
    function isHiddenCountry(c) {
			return hiddenCountries.indexOf(c) >= 0;
		}

		var projection = d3.geo.mercator()
			.center([-73, 14])
			.scale(width * 4 / 3)
			.translate([width / 2, height / 2]);

  	var path = d3.geo.path()
  		.projection(projection);

    var radius = d3.scale.sqrt()
      .domain([0, 200])
      .range([0, 50]);

    var voronoi = d3.geom.voronoi()
      .x(function(d) { return path.centroid(d)[0]; })
      .y(function(d) { return path.centroid(d)[1]; })
      .clipExtent([[0, 0], [width, height]]);

    var legend = svg.append("g")
        .attr("class", "legend")
        .attr("transform", "translate(" + (width - 75) + "," + 15 + ")")
      .selectAll("g")
        .data([150,50,10])
      .enter().append("g").attr("class", function(d){ return "legend-circle-" + d; });

    legend.append("circle")
        .attr("cy", radius)
        .attr("r", radius);
    legend.append("text")
        .attr("y", function(d) { return 2 * radius(d) - 20; })
        .attr("dy", "1.3em")
        .text(d3.format("d"));

    var legend150 = svg.selectAll(".legend-circle-150");
    legend150.append("text")
        .attr("dy", "1.3em")
        .attr("y", function(d) { return -20; })
        .attr("class", "consumption-label")
        .style("text-anchor","middle")
        .text("Total Consumption");
    var quotaLegend = legend150.append("text")
        .attr("y", function(d) { return 2 * radius(d) - 5; })
        .attr("dy", "1.3em")
        .attr("class", "quota-label")
        .style("text-anchor","middle");
      quotaLegend.append("tspan").attr("x",0).attr("dy","1.3em").text("Petrocaribe Quota");
      quotaLegend.append("tspan")
        .attr("x",0).attr("dy","1.3em")
        .classed("note", true)
        .text("(1000 barrels/day)");

  	d3.json("caribe.json", function(error, caribe) {
      if (error) return console.error(error);

  		console.log(caribe);

      var countries = topojson.feature(caribe, caribe.objects.countries);

    	svg.selectAll(".country")
    			.data(countries.features)
  		  .enter().append("path")
    			.attr("class", function(d) { return "country " + d.id; })
    			.attr("d", path)
					.classed("ghost", function(d) { return isHiddenCountry(d.id); });

			svg.append("path")
				.datum(topojson.mesh(caribe, caribe.objects.countries, function(a, b) {
					return a !== b && !(isHiddenCountry(a.id) && isHiddenCountry(b.id));
				}))
				.attr("d", path)
				.attr("class", "border");

			svg.append("path")
					.datum(topojson.mesh(caribe, caribe.objects.countries, function(a, b) {
						return a === b && isHiddenCountry(a.id)
							|| a !== b && isHiddenCountry(a.id) && isHiddenCountry(b.id);
					}))
					.attr("d", path)
					.attr("class", "border ghost");

      var bubble = svg.append("g")
        .attr("class", "bubble")
      .selectAll("circle")
        .data(countries.features
          .sort(function(a, b) { return b.properties.quotaKbd - a.properties.quotaKbd; })
          .filter(function(d) { return !isHiddenCountry(d.id); }))
      .enter();
      bubble.append("circle")
        .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; })
        .attr("r", function(d) { return radius(d.properties.quotaKbd) || 0; })
        .attr("class", function(d){ return "quota " + d.id; });
      bubble.append("circle")
        .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; })
        .attr("r", function(d) { return radius(d.properties.consumptionKbd) || 0; })
        .attr("class", function(d){ return "consumption " + d.id; });

      svg.selectAll(".country-label")
          .data(countries.features.filter(function(d) {
            return !isHiddenCountry(d.id);
          }))
      .enter().append("text")
        .attr("class", function(d) { return "country-label " + d.id; })
        .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; })
        .attr("dy", ".35em")
        .attr("font-size", 12)
        .text(function(d) { return d.properties.name; })
        .attr("x", function(d) {
          return ['KNA', 'VCT', 'DMA'].indexOf(d.id) >= 0 ? -7 :
                ['ATG', 'BLZ', 'LCA', 'GRD'].indexOf(d.id) >= 0 ? 10 : 0;
        })
        .style("text-anchor", function(d) {
          return ['KNA', 'VCT', 'DMA', 'SLV'].indexOf(d.id) >= 0 ? "end" :
                ['ATG', 'DOM', 'BLZ', 'LCA', 'GRD'].indexOf(d.id) >= 0 ? "start" : "middle";
        });

      bubble.append("text")
        .attr("transform", function(d) {
           return "translate(" + (path.centroid(d)[0])
              + "," + (path.centroid(d)[1] - (radius(d.properties.consumptionKbd) || 0)
              - ('VEN' === d.id ? -10 : 'BLZ' !== d.id ? 7 : 12)) + ")";
         })
        .attr("dy", ".35em")
        .attr("font-size", 12)
        .attr("class", function(d){ return "consumption-label specific " + d.id; })
        .style("text-anchor", function(d) {
          return ['DOM', 'VEN', 'GUY', 'SUR', 'JAM'].indexOf(d.id) >= 0 ? "middle" :
                 ['HND', 'NIC', 'SLV'].indexOf(d.id) >= 0 ? "start" : "end";
        })
        .text(function(d) { return d.properties.consumptionKbd + " KB/D"; });
      bubble.append("text")
        .attr("transform", function(d) {
           return "translate(" + (path.centroid(d)[0])
              + "," + (path.centroid(d)[1] + ((radius(d.properties.quotaKbd))||0)
              + (d.id !== 'GUY' ? 8 : 12)) + ")";
         })
        .attr("dy", ".35em")
        .attr("font-size", 12)
        .attr("class", function(d){ return "quota-label specific " + d.id; })
        .style("text-anchor", function(d) {
          return ['DOM', 'SUR', 'SLV'].indexOf(d.id) >= 0 ? "middle" :
                 ['GTM', 'CUB', 'JAM', 'HTI', 'GUY'].indexOf(d.id) < 0 ? "start" : "end";
        })
        .text(function(d) { return  d.properties.quotaKbd > 0 ?
          (d.properties.quotaKbd + " KB/D" + (d.id === 'CUB' ? "*" : "")) : ""; });


        //Initiate a group element to place the voronoi diagram in
        var voronoiGroup = svg.append("g")
          .attr("class", "voronoiWrapper");
        voronoiGroup.selectAll("path")
            .data(voronoi(countries.features.filter(function(d) {
              return !isHiddenCountry(d.id);
            }))) //Use vononoi() with your dataset inside
          .enter().append("path")
            .attr("d", function(d, i) { return "M" + d.join("L") + "Z"; })
          .attr("class", function(d,i) { return "voronoi " + d.id; })
            //.style("stroke", "#2074A0") //I use this to look at how the cells are dispersed as a check
            .style("fill", "none")
            .style("stroke-width", "1px")
            .style("pointer-events", "all")
            .on("mouseover", mouseover)
            .on("mouseout", mouseout)
            .on("touchstart", touchstart)
            .on("mousedown", mousedown)
            .on("mouseup", mouseup)
            .on("click", click);

        d3.select(window).on('resize', resize);

        function resize() {
            // adjust things when the window size changes
            width = parseInt(d3.select('#map').style('width'));
            width = width - margin.left - margin.right;
            height = width * mapRatio;

            // update projection
            projection
                .translate([width / 2, height / 2])
                .scale(width * 4 / 3);

            // resize the map container
            svg.attr('width', width).attr('height', height);

            // resize the map
            svg.selectAll('.country').attr('d', path);
            svg.selectAll('.border').attr('d', path);
            svg.selectAll(".country-label")
              .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; });
            svg.selectAll(".quota")
              .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; });
            svg.selectAll(".consumption")
              .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; });

            voronoi
              .x(function(d) { return path.centroid(d)[0]; })
              .y(function(d) { return path.centroid(d)[1]; })
              .clipExtent([[0, 0], [width, height]]);

              svg.selectAll(".voronoi")
                  .data(voronoi(countries.features.filter(function(d) {
                    return !isHiddenCountry(d.id);
                  })))
                  .attr("d", function(d, i) { return "M" + d.join("L") + "Z"; });

              svg.select(".legend").attr("transform", "translate(" + (width - 75) + "," + 15 + ")");
              svg.selectAll(".consumption-label.specific")
                .attr("transform", function(d) {
                   return "translate(" + (path.centroid(d)[0])
                      + "," + (path.centroid(d)[1] - (radius(d.properties.consumptionKbd) || 0)
                      - ('VEN' === d.id ? -10 : 'BLZ' !== d.id ? 8 : 12)) + ")";
                 })
               svg.selectAll(".quota-label.specific")
                 .attr("transform", function(d) {
                    return "translate(" + (path.centroid(d)[0])
                       + "," + (path.centroid(d)[1] + ((radius(d.properties.quotaKbd))||0)
                       + (d.id !== 'GUY' ? 8 : 12)) + ")";
                  })
        }
		});

    function mouseover(d,i) {
      d3.selectAll("."+d.point.id).classed("highlighted",true);
      d3.selectAll(".legend text").classed("highlighted",true);
    }

    function mouseout(d,i) {
      d3.selectAll("."+d.point.id).classed("highlighted",false);
      d3.selectAll(".legend text").classed("highlighted",false);
    }

    function mousedown(d,i) {
      d3.selectAll(".quota."+d.point.id).classed("mousedown",true);
      d3.selectAll(".consumption."+d.point.id).classed("mousedown",true);
      d3.select("#content-panel").classed("panel-info",false);
      d3.select("#content-panel").classed("panel-warning",true);
      d3.select("#content-panel").classed({"panel-info": false, "panel-warning": true});
    }

    function mouseup(d,i) {
      d3.selectAll(".quota."+d.point.id).classed("mousedown",false);
      d3.selectAll(".consumption."+d.point.id).classed("mousedown",false);
      d3.select("#content-panel").classed({"panel-info": true, "panel-warning": false});
    }

    function touchstart(d,i) {
      d3.selectAll(".highlighted").classed("highlighted",false);
      click(d,i);
    }

    function click(d,i) {
      var properties = d.point.properties;
      d3.select("#content-panel .content-title").text(properties.name);
      d3.select("#content-panel .panel-content").html("Products: <b> " + properties.products + "</b>");
    }

    //////////////////////////////////////////////////////////////
    //////////////////////// Auto Resize /////////////////////////
    //////////////////////////////////////////////////////////////

    </script>
</body>
`
