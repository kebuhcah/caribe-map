<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href="caribe.css"> </link>
<link rel="stylesheet" type="text/css" href="lib/bootstrap.min.css"> </link>
<link rel="stylesheet" type="text/css" href="lib/bootstrap-theme.min.css"> </link>
<body>
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <!-- Brand and toggle get grouped for better mobile display -->
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#">Petrocaribe: A Tragicomedy of Errors</a>
      </div>
    </div>
  </nav>
  <div class="row">
    <div class="col-md-3">
      <div class="panel panel-default">
        <div class="panel-heading">Introduction</div>
        <div class="panel-body">
          <b>Petrocaribe</b> is an oil alliance of many Caribbean states with Venezuela to purchase oil on conditions of preferential payment. The alliance was launched on 29 June 2005 in Puerto La Cruz, Venezuela. In 2013 Petrocaribe agreed links with the Bolivarian Alliance for the Americas (ALBA), to go beyond oil and promote economic cooperation.
        </div>
      </div>
    </div>
    <div class="col-md-9">
      <div class="panel panel-default">
        <div class="panel-heading">Petrocaribe Countries</div>
        <div id="map">
        </div>
      </div>
    </div>
  </div>
  <script src="lib/d3.v3.min.js" charset="utf-8"></script>
  <script src="lib/topojson.v1.min.js"></script>
  <script src="lib/bootstrap.min.js" charset="utf-8"></script>
  <script type="text/javascript">
    var margin = {top: 0, left: 0, bottom: 0, right: 0}
      , width = parseInt(d3.select('#map').style('width'))
      , width = width - margin.left - margin.right
      , mapRatio = .7
      , height = width * mapRatio;

    var svg = d3.select("#map").append("svg")
    		.attr("width", width)
        .attr("height", height)
				.attr("class", "root");
        var hiddenCountries = ['COL', 'BRA', 'PRI', 'FRA', 'MEX', 'BRB', 'SLV',
    		                       'USA', 'ECU', 'PER', 'PAN', 'CRI', 'TTO'];

		function isHiddenCountry(c) {
			return hiddenCountries.indexOf(c) >= 0;
		}

		var projection = d3.geo.mercator()
			.center([-73, 14])
			.scale(width * 4 / 3)
			.translate([width / 2, height / 2]);

  	var path = d3.geo.path()
  		.projection(projection);

    var dsv = d3.dsv(";","text/plain");
    dsv("caribe-official-data.csv", function(error, data) {
      if (error) return console.error(error);

      console.log(data);
    });

  	d3.json("caribe.json", function(error, caribe) {
      	if (error) return console.error(error);

  			console.log(caribe);

      var countries = topojson.feature(caribe, caribe.objects.countries);

    	svg.selectAll(".country")
    			.data(countries.features)
  		  .enter().append("path")
    			.attr("class", function(d) { return "country " + d.id; })
    			.attr("d", path)
					.classed("ghost", function(d) { return isHiddenCountry(d.id); });

			svg.append("path")
				.datum(topojson.mesh(caribe, caribe.objects.countries, function(a, b) {
					return a !== b && !(isHiddenCountry(a.id) && isHiddenCountry(b.id));
				}))
				.attr("d", path)
				.attr("class", "border");

			svg.append("path")
					.datum(topojson.mesh(caribe, caribe.objects.countries, function(a, b) {
						return a === b && isHiddenCountry(a.id)
							|| a !== b && isHiddenCountry(a.id) && isHiddenCountry(b.id);
					}))
					.attr("d", path)
					.attr("class", "ghost-border");

			/*svg.append("path")
				.datum(topojson.feature(caribe, caribe.objects.cities))
				.attr("d", path)
				.attr("class", "city");*/

			svg.selectAll(".country-label")
					.data(countries.features.filter(function(d) {
            return !isHiddenCountry(d.id);
          }))
				.enter().append("text")
					.attr("class", function(d) { return "country-label " + d.id; })
					.attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; })
					.attr("dy", ".35em")
          .attr("font-size", 12)
					.text(function(d) { return d.properties.name; })
					.style("text-anchor", function(d) {
						return ['KNA', 'VCT', 'DMA'].indexOf(d.id) >= 0 ? "end" :
									['ATG', 'DOM', 'BLZ', 'LCA', 'GRD'].indexOf(d.id) >= 0 ? "start" : "middle";
					});
		});

    d3.select(window).on('resize', resize);

    function resize() {
        // adjust things when the window size changes
        width = parseInt(d3.select('#map').style('width'));
        width = width - margin.left - margin.right;
        height = width * mapRatio;

        // update projection
        projection
            .translate([width / 2, height / 2])
            .scale(width);

        // resize the map container
        var map = d3.select('#map');
        map
            .style('width', width + 'px')
            .style('height', height + 'px');

        // resize the map
        map.select('.land').attr('d', path);
        map.selectAll('.state').attr('d', path);
    }

    </script>
</body>
